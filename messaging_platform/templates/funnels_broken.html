{% extends 'base.html' %}
{% block title %}Embudos - Plataforma de Mensajer√≠a{% endblock %}
{% block content %}
{% csrf_token %}
<div class="funnels-container">
    <div class="page-header">
        <h2>Embudos de {{ funnel_type|title }}</h2>
        <div>
            <a href="?type=sales" class="btn {% if funnel_type == 'sales' %}btn-primary{% else %}btn-outline{% endif %}">
                üìà Ventas
            </a>
            <a href="?type=support" class="btn {% if funnel_type == 'support' %}btn-primary{% else %}btn-outline{% endif %}">
                üõ†Ô∏è Soporte
            </a>
        </div>
    </div>

    <!-- Nota informativa -->
    <div class="info-banner">
        <div class="info-content">
            <span class="info-icon">üí°</span>
            <div class="info-text">
                <strong>¬øBuscas conversaciones nuevas para clasificar?</strong>
                <p>Las conversaciones pendientes de clasificaci√≥n est√°n ahora en la <a href="{% url 'inbox' %}">Bandeja de Entrada</a></p>
            </div>
            <a href="{% url 'inbox' %}" class="btn-inbox">
                üì• Ir a Bandeja de Entrada
            </a>
        </div>
    </div>

    <!-- Etapas del embudo -->
    <div class="funnel-stages-header">
        <h2>üéØ EMBUDO DE {{ funnel_type|title|upper }}</h2>
        <p>Conversaciones organizadas por etapa del proceso de {{ funnel_type }}</p>
    </div>
    
    <div class="funnel-stages" id="funnel-stages">
        {% for stage in funnel_data %}
        <div class="funnel-stage drop-zone" data-stage="{{ stage.stage_code }}">
            <div class="stage-header">
                <div class="stage-number">{{ forloop.counter }}</div>
                <div class="stage-info">
                    <h3>{{ stage.stage_name }}</h3>
                    <small class="stage-description">
                        {% if stage.stage_code == funnel_type|add:'_initial' %}
                        Conversaciones que acaban de ingresar al embudo
                        {% elif stage.stage_code == funnel_type|add:'_negotiation' %}
                        En proceso de negociaci√≥n activa
                        {% elif stage.stage_code == funnel_type|add:'_debate' %}
                        Resolviendo dudas y objeciones
                        {% elif stage.stage_code == funnel_type|add:'_closing' %}
                        Finalizando el proceso
                        {% elif stage.stage_code == funnel_type|add:'_process' %}
                        Procesando solicitud de soporte
                        {% else %}
                        Etapa del proceso de {{ funnel_type }}
                        {% endif %}
                    </small>
                </div>
                <span class="badge count-badge" id="count-{{ stage.stage_code }}">{{ stage.count }}</span>
            </div>
            <div class="stage-conversations" id="stage-{{ stage.stage_code }}">
                {% for conv in stage.conversations %}
                <div class="conversation-card draggable" 
                     data-conversation-id="{{ conv.id }}" 
                     data-current-stage="{{ stage.stage_code }}"
                     draggable="true">
                    <div class="card-header">
                        <strong>{{ conv.contact.name|default:conv.contact.phone }}</strong>
                        <small class="badge badge-{{ conv.contact.platform.name }}">{{ conv.contact.platform.name }}</small>
                    </div>
                    <div class="card-content">
                        <p class="last-message">{{ conv.last_message_preview|default:"Sin mensajes" }}</p>
                        <small class="text-muted">{{ conv.last_message_at|date:"d/m H:i" }}</small>
                        {% if conv.assigned_to %}
                        <small class="assigned-to">üë§ {{ conv.assigned_to.username }}</small>
                        {% endif %}
                    </div>
                    <div class="card-actions">
                        <button class="btn-small btn-outline" onclick="viewConversation({{ conv.id }})">
                            üí¨ Abrir Chat
                        </button>
                        <div class="move-buttons">
                            {% if not forloop.first %}
                            <button class="btn-small btn-secondary" onclick="moveConversation({{ conv.id }}, '{{ stage.prev_stage }}')">
                                ‚¨ÖÔ∏è
                            </button>
                            {% endif %}
                            {% if not forloop.last %}
                            <button class="btn-small btn-success" onclick="moveConversation({{ conv.id }}, '{{ stage.next_stage }}')">
                                ‚û°Ô∏è
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="empty-stage">
                    <p class="text-center text-muted">
                        {% if stage.stage_code == funnel_type|add:'_initial' %}
                        Arrastra conversaciones aqu√≠ para comenzar el embudo
                        {% else %}
                        Sin conversaciones en esta etapa
                        {% endif %}
                    </p>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal para confirmaci√≥n -->
<div id="confirmModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h4>Confirmar movimiento</h4>
        <p id="confirmMessage"></p>
        <div class="modal-actions">
            <button class="btn btn-primary" id="confirmYes">S√≠, mover</button>
            <button class="btn btn-secondary" id="confirmNo">Cancelar</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Banner informativo */
.info-banner {
    background: linear-gradient(135deg, #e3f2fd, #bbdefb);
    border: 2px solid #2196f3;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 10px rgba(33, 150, 243, 0.15);
}

.info-content {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
}

.info-icon {
    font-size: 2rem;
    color: #1976d2;
}

.info-text {
    flex: 1;
    min-width: 250px;
}

.info-text strong {
    color: #1565c0;
    font-size: 1.1rem;
    display: block;
    margin-bottom: 0.3rem;
}

.info-text p {
    color: #424242;
    margin: 0;
}

.info-text a {
    color: #1976d2;
    text-decoration: none;
    font-weight: 500;
}

.info-text a:hover {
    text-decoration: underline;
}

.btn-inbox {
    background: linear-gradient(135deg, #1976d2, #2196f3);
    color: white;
    padding: 0.8rem 1.5rem;
    border-radius: 8px;
    text-decoration: none;
    font-weight: bold;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    white-space: nowrap;
}

.btn-inbox:hover {
    background: linear-gradient(135deg, #1565c0, #1976d2);
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
}

/* Header de etapas del embudo */
.funnel-stages-header {
    text-align: center;
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
}

.funnel-stages-header h2 {
    margin: 0 0 0.5rem 0;
    font-weight: bold;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.funnel-stages-header p {
    margin: 0;
    opacity: 0.9;
    font-size: 1.1rem;
}

/* Etapas del embudo */
.funnel-stages {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
}

.funnel-stage {
    background: white;
    border-radius: 8px;
    padding: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    min-height: 400px;
    transition: all 0.3s ease;
}

.funnel-stage.drag-over {
    background: #f0f8ff;
    border: 2px dashed #007bff;
    transform: scale(1.02);
}

.stage-header {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #f1f3f4;
}

.stage-number {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-right: 1rem;
    font-size: 0.9rem;
}

.stage-info {
    flex: 1;
}

.stage-info h3 {
    margin: 0 0 0.25rem 0;
    color: #2c3e50;
    font-size: 1.1rem;
}

.stage-description {
    color: #6c757d;
    font-size: 0.85rem;
    line-height: 1.3;
}

.count-badge {
    background: #e9ecef;
    color: #495057;
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-weight: bold;
    font-size: 0.85rem;
}

.stage-conversations {
    min-height: 300px;
}

.conversation-card {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.75rem;
    cursor: move;
    transition: all 0.3s ease;
}

.conversation-card:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    transform: translateY(-1px);
}

.conversation-card.dragging {
    opacity: 0.7;
    transform: rotate(3deg);
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.card-header strong {
    color: #2c3e50;
    font-size: 0.95rem;
}

.badge {
    font-size: 0.75rem;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    text-transform: uppercase;
    font-weight: bold;
}

.badge-whatsapp { background: #25d366; color: white; }
.badge-telegram { background: #0088cc; color: white; }
.badge-email { background: #ea4335; color: white; }

.card-content {
    margin-bottom: 0.75rem;
}

.last-message {
    color: #495057;
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.text-muted {
    color: #6c757d;
    font-size: 0.8rem;
}

.assigned-to {
    color: #28a745;
    font-size: 0.8rem;
    font-weight: 500;
}

.card-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.5rem;
}

.btn-small {
    font-size: 0.8rem;
    padding: 0.4rem 0.8rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
}

.btn-outline {
    background: white;
    color: #007bff;
    border: 1px solid #007bff;
}

.btn-outline:hover {
    background: #007bff;
    color: white;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-success:hover {
    background: #218838;
}

.move-buttons {
    display: flex;
    gap: 0.25rem;
}

.empty-stage {
    text-align: center;
    padding: 2rem 1rem;
    color: #6c757d;
    font-style: italic;
}

.text-center {
    text-align: center;
}

/* Modal */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    max-width: 400px;
    width: 90%;
}

.modal-content h4 {
    margin-top: 0;
    color: #2c3e50;
}

.modal-actions {
    margin-top: 1.5rem;
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
}

.btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

/* Responsive */
@media (max-width: 768px) {
    .funnel-stages {
        grid-template-columns: 1fr;
    }
    
    .card-actions {
        flex-direction: column;
        align-items: stretch;
    }
    
    .move-buttons {
        justify-content: center;
        margin-top: 0.5rem;
    }
    
    .info-content {
        flex-direction: column;
        text-align: center;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Variables globales
let currentConversationId = null;
let currentTargetStage = null;

// Funci√≥n para ver conversaci√≥n
function viewConversation(conversationId) {
    window.open(`/chat/${conversationId}/`, '_blank');
}

// Funci√≥n para mover conversaci√≥n
function moveConversation(conversationId, targetStage) {
    const conversationCard = document.querySelector(`[data-conversation-id="${conversationId}"]`);
    const currentStage = conversationCard.getAttribute('data-current-stage');
    
    if (currentStage === targetStage) {
        return;
    }
    
    currentConversationId = conversationId;
    currentTargetStage = targetStage;
    
    // Mostrar modal de confirmaci√≥n
    document.getElementById('confirmMessage').textContent = 
        `¬øMover esta conversaci√≥n a la siguiente etapa?`;
    document.getElementById('confirmModal').style.display = 'flex';
}

// Funci√≥n para actualizar embudo de conversaci√≥n
function updateConversationFunnel(conversationId, funnelType, stage) {
    fetch(`/api/conversations/${conversationId}/funnel/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            funnel_type: funnelType,
            funnel_stage: stage
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Recargar la p√°gina para mostrar los cambios
            location.reload();
        } else {
            alert('Error al mover la conversaci√≥n');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al mover la conversaci√≥n');
    });
}

// Event listeners
document.getElementById('confirmYes').addEventListener('click', function() {
    if (currentConversationId && currentTargetStage) {
        const funnelType = '{{ funnel_type }}';
        updateConversationFunnel(currentConversationId, funnelType, currentTargetStage);
    }
    document.getElementById('confirmModal').style.display = 'none';
});

document.getElementById('confirmNo').addEventListener('click', function() {
    document.getElementById('confirmModal').style.display = 'none';
    currentConversationId = null;
    currentTargetStage = null;
});

// Drag and drop functionality
document.addEventListener('DOMContentLoaded', function() {
    const conversations = document.querySelectorAll('.conversation-card.draggable');
    const dropZones = document.querySelectorAll('.funnel-stage.drop-zone');
    
    conversations.forEach(conversation => {
        conversation.addEventListener('dragstart', function(e) {
            this.classList.add('dragging');
            e.dataTransfer.setData('text/plain', this.getAttribute('data-conversation-id'));
        });
        
        conversation.addEventListener('dragend', function(e) {
            this.classList.remove('dragging');
        });
    });
    
    dropZones.forEach(dropZone => {
        dropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        });
        
        dropZone.addEventListener('dragleave', function(e) {
            this.classList.remove('drag-over');
        });
        
        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            const conversationId = e.dataTransfer.getData('text/plain');
            const targetStage = this.getAttribute('data-stage');
            const conversationCard = document.querySelector(`[data-conversation-id="${conversationId}"]`);
            const currentStage = conversationCard.getAttribute('data-current-stage');
            
            if (currentStage !== targetStage) {
                const funnelType = '{{ funnel_type }}';
                updateConversationFunnel(conversationId, funnelType, targetStage);
            }
        });
    });
});
</script>
{% endblock %}