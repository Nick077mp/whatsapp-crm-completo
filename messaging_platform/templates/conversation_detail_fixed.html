{% extends 'base.html' %}
{% block title %}Chat con {{ conversation.contact.display_name }} - Plataforma de Mensajer√≠a{% endblock %}

{% block extra_css %}
<style>
/* Variables CSS para consistencia */
:root {
    --primary-color: #007bff;
    --danger-color: #dc3545;
    --success-color: #28a745;
    --warning-color: #ffc107;
    --info-color: #17a2b8;
    --secondary-color: #6c757d;
    --light-color: #f8f9fa;
    --dark-color: #343a40;
    --border-color: #dee2e6;
}

/* Estilos del contenedor principal */
.conversation-detail-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 1rem;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    min-height: 80vh;
}

.conversation-header {
    background: var(--light-color);
    border-bottom: 1px solid var(--border-color);
    padding: 1rem;
    margin: -1rem -1rem 1rem -1rem;
    border-radius: 8px 8px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.messages-container {
    max-height: 400px;
    overflow-y: auto;
    padding: 1rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    margin-bottom: 1rem;
    background: #fafafa;
}

.message {
    margin-bottom: 1rem;
    padding: 0.75rem;
    border-radius: 8px;
    max-width: 70%;
}

.message-sent {
    background: var(--primary-color);
    color: white;
    margin-left: auto;
    text-align: right;
}

.message-received {
    background: white;
    border: 1px solid var(--border-color);
    margin-right: auto;
}

.message-header {
    font-size: 0.8rem;
    margin-bottom: 0.5rem;
    opacity: 0.8;
}

.message-input-container {
    display: flex;
    gap: 1rem;
    align-items: flex-end;
}

.message-input-wrapper {
    flex: 1;
}

#messageInput {
    width: 100%;
    min-height: 60px;
    padding: 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    resize: vertical;
    font-family: inherit;
}

.btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    text-decoration: none;
    display: inline-block;
    text-align: center;
    transition: all 0.3s ease;
}

.btn-primary {
    background: var(--primary-color);
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
}

.btn-outline {
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--dark-color);
}

.btn-whatsapp {
    background: #25d366;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
</style>
{% endblock %}

{% block content %}
<div class="conversation-detail-container">
    <div class="conversation-header">
        <div class="header-left">
            <a href="{% url 'inbox' %}" class="btn btn-outline">‚Üê Volver a Bandeja de Entrada</a>
            <h3>{{ conversation.contact.display_name }}</h3>
            <span class="badge">{{ conversation.contact.platform.name|title }}</span>
            {% if conversation.contact.platform.name == 'whatsapp' %}
            <button class="btn-whatsapp" onclick="openWhatsApp('{{ conversation.contact.whatsapp_number|default:conversation.contact.platform_user_id }}')" title="Abrir en WhatsApp">
                üì± Abrir en WhatsApp
            </button>
            {% endif %}
        </div>
    </div>

    <div class="messages-container" id="messagesContainer">
        {% for message in messages %}
        <div class="message {% if message.sender_type == 'agent' %}message-sent{% else %}message-received{% endif %}">
            <div class="message-header">
                <strong>{{ message.sender_name }}</strong>
                <small>{{ message.created_at|date:"d/m/Y H:i" }}</small>
            </div>
            <div class="message-content">
                {{ message.content }}
                {% if message.media_url %}
                    {% if message.message_type == 'image' %}
                        <div class="media-container">
                            <img src="{{ message.media_url }}" alt="Imagen" style="max-width: 200px; border-radius: 4px;">
                        </div>
                    {% elif message.message_type == 'video' %}
                        <div class="media-container">
                            <video controls style="max-width: 200px;">
                                <source src="{{ message.media_url }}" type="video/mp4">
                            </video>
                        </div>
                    {% elif message.message_type == 'audio' %}
                        <div class="media-container">
                            <audio controls>
                                <source src="{{ message.media_url }}" type="audio/mpeg">
                            </audio>
                        </div>
                    {% elif message.message_type == 'document' %}
                        <div class="media-container">
                            <a href="{{ message.media_url }}" target="_blank" class="btn btn-outline">
                                üìÑ Abrir documento
                            </a>
                        </div>
                    {% endif %}
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div style="text-align: center; color: #666; padding: 2rem;">
            No hay mensajes en esta conversaci√≥n
        </div>
        {% endfor %}
    </div>

    <div class="message-input-container">
        <div class="message-input-wrapper">
            <textarea id="messageInput" placeholder="Escribe tu mensaje aqu√≠..." rows="3"></textarea>
        </div>
        <button class="btn btn-primary" onclick="sendMessage()" id="sendBtn">Enviar</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const conversationId = {{ conversation.id }};
const platform = '{{ conversation.contact.platform.name }}';
const recipientId = '{{ conversation.contact.platform_user_id }}';

function openWhatsApp(phoneNumber) {
    if (phoneNumber) {
        window.open(`https://wa.me/${phoneNumber}`, '_blank');
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function sendMessage() {
    const input = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendBtn');
    const message = input.value.trim();
    
    if (!message) {
        alert('Por favor escribe un mensaje');
        return;
    }
    
    sendButton.disabled = true;
    sendButton.textContent = 'Enviando...';
    
    fetch('/api/whatsapp/send-message/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            conversation_id: conversationId,
            message: message,
            platform: platform,
            recipient_id: recipientId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            input.value = '';
            loadMessages(); // Recargar mensajes
        } else {
            alert('Error al enviar mensaje: ' + (data.error || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al enviar mensaje');
    })
    .finally(() => {
        sendButton.disabled = false;
        sendButton.textContent = 'Enviar';
    });
}

function loadMessages() {
    fetch(`/api/conversations/${conversationId}/messages/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Actualizar los mensajes (implementaci√≥n simplificada)
                location.reload();
            }
        })
        .catch(error => console.error('Error al cargar mensajes:', error));
}

// Enter para enviar mensaje
document.getElementById('messageInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// Auto-scroll al final de mensajes
document.addEventListener('DOMContentLoaded', function() {
    const messagesContainer = document.getElementById('messagesContainer');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
});
</script>
{% endblock %}